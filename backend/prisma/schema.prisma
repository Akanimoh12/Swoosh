// Prisma schema for Swoosh backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum for intent/route status
enum Status {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Intent represents a user's natural language request
model Intent {
  id            String   @id @default(cuid())
  userAddress   String   @map("user_address")
  rawInput      String   @map("raw_input") @db.Text
  parsedData    Json     @map("parsed_data")
  status        Status   @default(PENDING)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  routes        Route[]
  
  // Indexes for frequently queried columns
  @@index([userAddress, createdAt], name: "idx_user_created")
  @@index([status, createdAt], name: "idx_status_created")
  @@index([userAddress, status], name: "idx_user_status")
  @@map("intents")
}

// Route represents an optimized execution path for an intent
model Route {
  id              String   @id @default(cuid())
  intentId        String   @map("intent_id")
  intentHash      String   @map("intent_hash")
  routeData       Json     @map("route_data")
  costEstimate    String   @map("cost_estimate") // Stored as string to avoid precision loss
  estimatedTime   Int      @map("estimated_time") // Estimated execution time in seconds
  expiration      DateTime
  isSelected      Boolean  @default(false) @map("is_selected")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  intent          Intent   @relation(fields: [intentId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([intentHash], name: "idx_intent_hash")
  @@index([intentId, createdAt], name: "idx_intent_created")
  @@index([expiration], name: "idx_expiration")
  @@map("routes")
}

// Token prices cache (optional - can also use Redis only)
model TokenPrice {
  id              String   @id @default(cuid())
  tokenAddress    String   @unique @map("token_address")
  chainId         Int      @map("chain_id")
  priceUsd        String   @map("price_usd") // Stored as string to avoid precision loss
  lastUpdated     DateTime @default(now()) @map("last_updated")
  
  @@index([tokenAddress, chainId], name: "idx_token_chain")
  @@map("token_prices")
}

// Gas prices cache (optional - can also use Redis only)
model GasPrice {
  id              String   @id @default(cuid())
  chainId         Int      @unique @map("chain_id")
  gasPriceGwei    String   @map("gas_price_gwei") // Stored as string to avoid precision loss
  lastUpdated     DateTime @default(now()) @map("last_updated")
  
  @@map("gas_prices")
}

// CCIP Message Status Enum
enum CCIPStatus {
  PENDING
  IN_FLIGHT
  SUCCESS
  FAILED
  TIMEOUT
}

// CCIP Message tracking for cross-chain transfers
model CCIPMessage {
  id                    String     @id @default(cuid())
  messageId             String     @unique @map("message_id") // CCIP message ID (bytes32)
  intentId              String     @map("intent_id")
  txHash                String     @map("tx_hash")
  sourceChainId         Int        @map("source_chain_id")
  sourceChainSelector   String     @map("source_chain_selector")
  destChainId           Int        @map("dest_chain_id")
  destChainSelector     String     @map("dest_chain_selector")
  token                 String
  amount                String     // Stored as string to avoid precision loss
  sender                String
  recipient             String
  status                CCIPStatus @default(PENDING)
  destTxHash            String?    @map("dest_tx_hash")
  feeAmount             String?    @map("fee_amount")
  feeToken              String?    @map("fee_token")
  errorMessage          String?    @map("error_message")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")
  completedAt           DateTime?  @map("completed_at")
  
  // Indexes for querying
  @@index([intentId], name: "idx_ccip_intent")
  @@index([status, createdAt], name: "idx_ccip_status_created")
  @@index([sender, createdAt], name: "idx_ccip_sender_created")
  @@index([sourceChainId, destChainId], name: "idx_ccip_chains")
  @@map("ccip_messages")
}

// User Analytics - Daily aggregated statistics per user
model UserAnalytics {
  id                  String   @id @default(cuid())
  userAddress         String   @map("user_address")
  date                DateTime @db.Date // Daily aggregation date
  totalIntents        Int      @default(0) @map("total_intents")
  completedIntents    Int      @default(0) @map("completed_intents")
  failedIntents       Int      @default(0) @map("failed_intents")
  totalVolumeUsd      String   @default("0") @map("total_volume_usd")
  totalGasSpent       String   @default("0") @map("total_gas_spent")
  totalGasSaved       String   @default("0") @map("total_gas_saved")
  avgExecutionTime    Int      @default(0) @map("avg_execution_time") // in seconds
  chainDistribution   Json     @default("{}") @map("chain_distribution") // { "ethereum": 5, "arbitrum": 10 }
  tokenDistribution   Json     @default("{}") @map("token_distribution") // { "USDC": 5, "ETH": 3 }
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@unique([userAddress, date], name: "unique_user_date")
  @@index([userAddress, date], name: "idx_user_analytics_date")
  @@map("user_analytics")
}

// Platform Analytics - Daily aggregated platform-wide statistics
model PlatformAnalytics {
  id                  String   @id @default(cuid())
  date                DateTime @unique @db.Date // Daily aggregation date
  totalIntents        Int      @default(0) @map("total_intents")
  completedIntents    Int      @default(0) @map("completed_intents")
  failedIntents       Int      @default(0) @map("failed_intents")
  uniqueUsers         Int      @default(0) @map("unique_users")
  totalVolumeUsd      String   @default("0") @map("total_volume_usd")
  totalGasSpent       String   @default("0") @map("total_gas_spent")
  totalGasSaved       String   @default("0") @map("total_gas_saved")
  avgExecutionTime    Int      @default(0) @map("avg_execution_time")
  avgGasSavedPerUser  String   @default("0") @map("avg_gas_saved_per_user")
  chainDistribution   Json     @default("{}") @map("chain_distribution")
  tokenDistribution   Json     @default("{}") @map("token_distribution")
  topDestChain        String?  @map("top_dest_chain")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@index([date], name: "idx_platform_analytics_date")
  @@map("platform_analytics")
}
